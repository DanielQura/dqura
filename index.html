<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد عرب درونز الذكي</title>
    <!-- SEO: Add a concise and relevant meta description -->
    <meta name="description" content="مساعد عرب درونز الذكي يقدم لك معلومات حول قوانين الطائرات بدون طيار في الدول العربية ويجيب على أسئلتك العامة حول الدرونز.">
    
    <!-- Removed: Link to manifest.json as PWA features are not fully supported in this environment -->

    <!-- Tailwind CSS CDN for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: IBM Plex Sans Arabic for better readability in Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Define CSS variables for theming (Dark and Light modes) */
        :root {
            --bg-primary: #0e0e0f;
            --bg-secondary: #1a1a1b;
            --bg-tertiary: #2c2c2e;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-color: #3a3a3c;
            --accent-color: #2dd4bf;
            --accent-text: #111827;
        }

        body.light-theme {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #0d9488;
            --accent-text: #ffffff;
        }

        /* Base styles for the body, applying font and theme transitions */
        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom scrollbar styling for the chat messages area - Hiding scrollbar */
        #chat-messages::-webkit-scrollbar {
            width: 0; /* For Chrome, Safari, and Opera */
            height: 0;
        }
        #chat-messages {
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
            scrollbar-width: none;  /* For Firefox */
        }

        /* Typing indicator animation for a more dynamic feel */
        .typing-indicator span {
            height: 10px;
            width: 10px;
            float: left;
            margin: 0 1px;
            background-color: var(--text-secondary);
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.4; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }

        /* Styling for suggestion/quick action buttons */
        .suggestion-btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .suggestion-btn:hover {
            background-color: var(--border-color);
        }

        /* Styling for headings and lists within bot responses */
        .bot-response-content h4 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }
        .bot-response-content ul {
            list-style-type: disc;
            padding-right: 1.5rem; /* For RTL support */
            margin-bottom: 1rem;
        }
        .bot-response-content a {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* Accent color utilities for backgrounds and hover effects */
        .accent-bg {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        .accent-bg-hover:hover {
            filter: brightness(1.1);
        }

        /* Styling for information cards used in structured bot responses */
        .info-card {
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
        }

        /* Styling for important disclaimers/notes */
        .disclaimer {
            border-right: 4px solid #facc15; /* For RTL, acts as a left border visually */
            background-color: rgba(250, 204, 21, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        /* Mobile responsiveness adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.25rem; /* Slightly smaller heading on mobile */
            }
            header {
                flex-direction: row; /* Keep row direction */
                align-items: center; /* Center items vertically */
                justify-content: space-between; /* Space out title and links */
                padding-left: 0.75rem; /* Smaller padding on edges */
                padding-right: 0.75rem;
            }
            header .flex-grow {
                text-align: right; /* Ensure title is right-aligned in RTL */
            }
            header .flex.items-center {
                gap: 0.5rem; /* Smaller gap between links/buttons */
            }
            .nav-link-btn { /* Specific style for the "عرب درونز" button on mobile */
                padding: 6px 10px; /* Smaller padding */
                font-size: 0.75rem; /* Smaller font size */
            }
            .theme-toggle-btn-mobile { /* Specific style for theme toggle on mobile */
                padding: 0.25rem; /* Smaller padding */
            }
            /* Hide text for very small screens, only show icon for "عرب درونز" button */
            .arab-drones-text {
                display: inline;
            }
            .arab-drones-icon {
                display: none;
            }
            @media (max-width: 480px) { /* Even smaller screens */
                .arab-drones-text {
                    display: none; /* Hide text */
                }
                .arab-drones-icon {
                    display: inline-block; /* Show icon */
                }
                .px-4.py-2.rounded-full {
                     padding: 0.5rem 0.75rem; /* adjust padding if icon only */
                }
            }
        }
    </style>
<script data-cfasync="false" nonce="d8dd967e-337c-4dfe-8f62-0558da14d150">try{(function(w,d){!function(fv,fw,fx,fy){if(fv.zaraz)console.error("zaraz is loaded twice");else{fv[fx]=fv[fx]||{};fv[fx].executed=[];fv.zaraz={deferred:[],listeners:[]};fv.zaraz._v="5858";fv.zaraz._n="d8dd967e-337c-4dfe-8f62-0558da14d150";fv.zaraz.q=[];fv.zaraz._f=function(fz){return async function(){var fA=Array.prototype.slice.call(arguments);fv.zaraz.q.push({m:fz,a:fA})}};for(const fB of["track","set","debug"])fv.zaraz[fB]=fv.zaraz._f(fB);fv.zaraz.init=()=>{var fC=fw.getElementsByTagName(fy)[0],fD=fw.createElement(fy),fE=fw.getElementsByTagName("title")[0];fE&&(fv[fx].t=fw.getElementsByTagName("title")[0].text);fv[fx].x=Math.random();fv[fx].w=fv.screen.width;fv[fx].h=fv.screen.height;fv[fx].j=fv.innerHeight;fv[fx].e=fv.innerWidth;fv[fx].l=fv.location.href;fv[fx].r=fw.referrer;fv[fx].k=fv.screen.colorDepth;fv[fx].n=fw.characterSet;fv[fx].o=(new Date).getTimezoneOffset();if(fv.dataLayer)for(const fF of Object.entries(Object.entries(dataLayer).reduce(((fG,fH)=>({...fG[1],...fH[1]})),{})))zaraz.set(fF[0],fF[1],{scope:"page"});fv[fx].q=[];for(;fv.zaraz.q.length;){const fI=fv.zaraz.q.shift();fv[fx].q.push(fI)}fD.defer=!0;for(const fJ of[localStorage,sessionStorage])Object.keys(fJ||{}).filter((fL=>fL.startsWith("_zaraz_"))).forEach((fK=>{try{fv[fx]["z_"+fK.slice(7)]=JSON.parse(fJ.getItem(fK))}catch{fv[fx]["z_"+fK.slice(7)]=fJ.getItem(fK)}}));fD.referrerPolicy="origin";fD.src="/cdn-cgi/zaraz/s.js?z="+btoa(encodeURIComponent(JSON.stringify(fv[fx])));fC.parentNode.insertBefore(fD,fC)};["complete","interactive"].includes(fw.readyState)?zaraz.init():fv.addEventListener("DOMContentLoaded",zaraz.init)}}(w,d,"zarazData","script");window.zaraz._p=async eC=>new Promise((eD=>{if(eC){eC.e&&eC.e.forEach((eE=>{try{const eF=d.querySelector("script[nonce]"),eG=eF?.nonce||eF?.getAttribute("nonce"),eH=d.createElement("script");eG&&(eH.nonce=eG);eH.innerHTML=eE;eH.onload=()=>{d.head.removeChild(eH)};d.head.appendChild(eH)}catch(eI){console.error(`Error executing script: ${eE}\n`,eI)}}));Promise.allSettled((eC.f||[]).map((eJ=>fetch(eJ[0],eJ[1]))))}eD()}));zaraz._p({"e":["(function(w,d){})(window,document)"]});})(window,document)}catch(e){throw fetch("/cdn-cgi/zaraz/t"),e;};</script></head>
<body class="antialiased">

    <div id="chat-container" class="flex flex-col h-screen">
        
        <!-- Header Section -->
        <header style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="text-white p-4 shadow-md z-10 flex justify-between items-center">
             <!-- Right side (RTL: Right side) - Title -->
             <div class="flex-grow text-right"> 
                 <h1 class="text-xl md:text-2xl font-semibold" style="color: var(--text-primary);">مساعد عرب درونز الذكي ✨</h1>
             </div>
             
             <!-- Left side (RTL: Left side) - Navigation Links and Theme Toggle -->
             <div class="flex items-center gap-4">
                 <!-- عرب درونز button with accent color and globe icon -->
                 <a href="https://arabdrones.com/" target="_blank" rel="noopener noreferrer" 
                    class="nav-link-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1" 
                    style="background-color: var(--accent-color); color: var(--accent-text); white-space: nowrap; border: none;">
                    <span class="arab-drones-text">عرب درونز</span>
                    <!-- Globe SVG Icon -->
                    <svg class="arab-drones-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512" fill="currentColor"><path d="M352 256c0 22.2-1.2 43.6-3.3 64l-185.3 0c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64l185.3 0c2.2 20.4 3.3 41.8 3.3 64zm28.8-64l123.1 0c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64l-123.1 0c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32l-116.7 0c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0l-176.6 0c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0L18.6 160C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192l123.1 0c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64L8.1 320C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6l176.6 0c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352l116.7 0zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6l116.7 0z"/></svg>
                 </a>
                 
                 <!-- Theme Toggle Button with SVG Icons -->
                 <button id="theme-toggle-btn" class="p-1 theme-toggle-btn-mobile" style="color: var(--text-secondary);" title="تبديل المظهر">
                     <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden">
                         <circle cx="12" cy="12" r="5"/>
                         <line x1="12" y1="1" x2="12" y2="3"/>
                         <line x1="12" y1="21" x2="12" y2="23"/>
                         <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                         <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                         <line x1="1" y1="12" x2="3" y2="12"/>
                         <line x1="21" y1="12" x2="23" y2="12"/>
                         <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                         <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                     </svg>
                     <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                     </svg>
                 </button>
             </div>
        </header>

        <!-- Main chat messages display area -->
        <main id="chat-messages" class="flex-1 w-full max-w-4xl mx-auto p-6 overflow-y-auto space-y-8"></main>

        <!-- Footer section containing feature buttons and chat input -->
        <div class="w-full max-w-4xl mx-auto p-4">
            <!-- Feature Buttons moved above the input field -->
            <div id="feature-buttons-container" class="flex justify-center gap-2 pb-4 flex-wrap">
                <!-- Drone Laws Button -->
                <button type="button" id="drone-laws-btn" class="suggestion-btn flex items-center gap-1" title="⚖️ خبير قوانين الدرونز">
                    <span>قوانين الدرونز</span>
                </button>
                <!-- New Suggestions Button -->
                <button type="button" id="suggestions-btn" class="suggestion-btn flex items-center gap-1" title="✨ اقتراحات للمتابعة">
                    <span>اقتراحات</span>
                </button>
            </div>

            <div id="quick-actions-container" class="pb-2"></div>
            <div id="typing-indicator-container" class="px-6 pb-2 hidden"></div>
            <form id="chat-form" class="flex items-center gap-2 rounded-full border p-2" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <!-- Chat Input Field -->
                <input type="text" id="chat-input" placeholder="اكتب رسالتك..." autocomplete="off" class="flex-1 w-full px-4 py-2 bg-transparent focus:outline-none placeholder-gray-400" style="color: var(--text-primary);">
                <!-- Send Button -->
                <button type="submit" class="accent-bg accent-bg-hover rounded-full p-2 transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>

        <!-- Developed By Footer
        <footer class="w-full text-center p-4 text-sm" style="background-color: var(--bg-primary); color: var(--text-secondary);">
أحد منتجات عرب درونز | مدعوم بـ Gemini | قبل ما تعتمد دور وتاكد ai بهبد مرات
        </footer> -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SCRIPT START ---

            // 1. DOM Elements
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const quickActionsContainer = document.getElementById('quick-actions-container');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const droneLawsBtn = document.getElementById('drone-laws-btn');
            const suggestionsBtn = document.getElementById('suggestions-btn'); // Get the new suggestions button

            // 2. State Management Variables
            let chatHistory = []; 
            let messageIdCounter = 0; 
            let isSuggesting = false; 
            let activeFlow = null; 

            // 3. API & Schemas
            // IMPORTANT: The API key is included directly as per user request. 
            // In a production environment, this should ideally be handled via a secure backend
            // to prevent client-side exposure and ensure better security.
            const apiKey = "AIzaSyAYhira7vwa47RxXxLJXKcEMDwpccYK0qc"; 
            const getApiUrl = () => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // JSON Schemas for structured responses from the Large Language Model (LLM)
            const questionsSchema = { type: "OBJECT", properties: { questions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["questions"] };
            const responseSchema = { type: "OBJECT", properties: { summary: { type: "STRING" }, points: { type: "ARRAY", items: { type: "STRING" } }, sources: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, url: { type: "STRING" } } } } }, required: ["summary", "points"] };
            const lawsSchema = { type: "OBJECT", properties: { registration: { type: "STRING" }, noFlyZones: { type: "ARRAY", items: { type: "STRING" } }, generalRules: { type: "ARRAY", items: { type: "STRING" } }, disclaimer: { type: "STRING" } }, required: ["registration", "noFlyZones", "generalRules", "disclaimer"] };

            // 4. Core Utility Functions (Made global for HTML onclick access where needed)

            /**
             * Scrolls the chat messages container to the bottom for new messages.
             */
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            /**
             * Displays a visual typing indicator to show the bot is processing.
             */
            function showTypingIndicator() {
                document.getElementById('typing-indicator-container').innerHTML = `<div class="flex items-start gap-3 justify-start"><div class="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">✨</div><div class="p-4 rounded-lg rounded-tl-none" style="background-color: var(--bg-secondary);"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
                document.getElementById('typing-indicator-container').classList.remove('hidden');
                scrollToBottom();
            }

            /**
             * Hides the typing indicator.
             */
            const hideTypingIndicator = () => {
                document.getElementById('typing-indicator-container').classList.add('hidden');
            };

            /**
             * Displays a loading animation within a given container (e.g., for quick action suggestions).
             * @param {HTMLElement} container - The DOM element to display the loader in.
             */
            function displaySuggestionLoader(container) {
                container.innerHTML = `<div class="flex justify-center p-2"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
                scrollToBottom();
            }
            
            /**
             * Creates and displays interactive buttons for user suggestions or quick actions.
             * @param {HTMLElement} container - The DOM element to append the buttons to.
             * @param {string[]} questions - An array of strings, each representing a button's text.
             */
            window.displaySuggestionButtons = function(container, questions) {
                container.innerHTML = ''; 
                const wrapper = document.createElement('div');
                wrapper.className = `flex gap-2 p-2 justify-center flex-wrap`;
                if (Array.isArray(questions)) {
                    questions.forEach(q => {
                        const button = document.createElement('button');
                        button.textContent = q;
                        button.className = 'suggestion-btn';
                        button.onclick = () => {
                            chatInput.value = q;
                            handleFormSubmit(new Event('submit', { bubbles: true })); 
                        };
                        wrapper.appendChild(button);
                    });
                }
                container.appendChild(wrapper);
                scrollToBottom();
            }

            /**
             * Displays options as quick action buttons at the bottom of the chat, typically used for flow-specific choices.
             * @param {string[]} options - An array of strings for the button texts.
             * @param {Function} handler - The callback function to execute when an option button is clicked.
             */
            window.displayQuickActionOptions = function(options, handler) {
                const wrapper = document.createElement('div');
                wrapper.className = `flex gap-2 p-2 justify-center flex-wrap`;
                options.forEach(q => {
                    const button = document.createElement('button');
                    button.textContent = q;
                    button.className = 'suggestion-btn';
                    button.onclick = () => handler(q); 
                    wrapper.appendChild(button);
                });
                quickActionsContainer.innerHTML = ''; 
                quickActionsContainer.appendChild(wrapper);
                scrollToBottom();
            }
            
            /**
             * Toggles the theme between light and dark mode and saves the preference.
             */
            function toggleTheme() {
                document.body.classList.toggle('light-theme');
                const theme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                localStorage.setItem('arabDronesTheme', theme); 
                updateThemeIcons(theme);
            }

            /**
             * Loads the user's saved theme preference on page load.
             */
            function loadTheme() {
                const savedTheme = localStorage.getItem('arabDronesTheme') || 'dark'; 
                if (savedTheme === 'light') {
                    document.body.classList.add('light-theme');
                }
                updateThemeIcons(savedTheme);
            }

            /**
             * Updates the visibility of the sun/moon icons based on the current theme.
             * @param {string} theme - 'light' or 'dark'.
             */
            function updateThemeIcons(theme) {
                document.getElementById('theme-icon-sun').classList.toggle('hidden', theme === 'dark');
                document.getElementById('theme-icon-moon').classList.toggle('hidden', theme === 'light');
            }
            
            /**
             * Handles the submission of the chat input form.
             * Delegates to specific flow handlers if a flow is active, otherwise triggers general bot response.
             * @param {Event} e - The submit event object.
             */
            async function handleFormSubmit(e) {
                e.preventDefault(); 
                const messageText = chatInput.value.trim();

                if (activeFlow === 'laws') {
                    handleLawsChoice(messageText);
                    return;
                }
                // If user types during any active flow that isn't 'laws', it will fall through to general chat after reset
                if (activeFlow) { 
                    appendMessage({text: messageText}, 'user');
                    resetFlowState();
                    await getBotResponse();
                    return;
                }

                if (!messageText) return; 

                quickActionsContainer.innerHTML = ''; 
                appendMessage({ text: messageText }, 'user'); 
                chatHistory.push({ role: 'user', parts: [{ text: messageText }] }); 
                saveChatHistory(); 
                chatInput.value = ''; 
                showTypingIndicator(); 
                await getBotResponse(); 
            }

            /**
             * Appends a message to the chat display, styling it based on sender.
             * @param {Object|string} content - The message content.
             * @param {string} sender - 'user' or 'bot'.
             * @param {Object} [options={}] - Additional options.
             */
            function appendMessage(content, sender, options = {}) {
                messageIdCounter++; 
                const { isInitial = false, htmlContent = null } = options;
                const messageWrapper = document.createElement('div');
                let messageHtml = '';

                if (sender === 'user') {
                    messageWrapper.className = 'flex items-start gap-3 justify-end'; 
                    let textHtml = content.text ? `<p>${content.text}</p>` : '';
                    messageHtml = `<div class="accent-bg p-4 rounded-xl rounded-br-none max-w-lg shadow">${textHtml}</div><div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 border" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">U</div>`;
                } else {
                    const formattedHtml = htmlContent ? htmlContent : (typeof content === 'string' ? `<p>${content}</p>` : window.formatBotResponse(content));
                    // Removed inline follow-up suggestions button as per user request to avoid duplication
                    const followUpButton = ''; 
                    messageWrapper.className = 'flex flex-col items-start gap-2'; 
                    messageHtml = `<div class="flex items-start gap-3 justify-start w-full"><div class="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">✨</div><div class="p-4 rounded-xl rounded-bl-none max-w-lg w-full bot-response-content" style="background-color: var(--bg-secondary);">${formattedHtml}</div></div>${followUpButton}`;
                }
                messageWrapper.innerHTML = messageHtml;
                chatMessages.appendChild(messageWrapper);
                scrollToBottom();
            }

            /**
             * Sets the current active conversational flow.
             * @param {string} flowName - The name of the flow ('laws' or null).
             * @param {string} placeholderText - The placeholder text for the chat input during this flow.
             * @param {boolean} [disableInput=true] - Whether to disable the main chat input field.
             */
            function setFlowState(flowName, placeholderText, disableInput = true) {
                activeFlow = flowName;
                quickActionsContainer.innerHTML = ''; 
                chatInput.disabled = disableInput;
                chatInput.placeholder = placeholderText;
            }

            /**
             * Resets the active conversational flow state to default.
             * Re-enables the chat input and restores its default placeholder.
             */
            function resetFlowState() {
                activeFlow = null;
                chatInput.disabled = false;
                chatInput.placeholder = 'اكتب رسالتك...'; 
            }
            
            // 5. Specific Flow Handlers (Only Drone Laws remains)

            /**
             * Initiates the Drone Laws conversational flow.
             */
            function startLawsFlow() {
                if (activeFlow) return; 
                setFlowState('laws', 'الرجاء إدخال اسم البلد (مثال: الأردن)', false); 
                appendMessage("⚖️ أهلاً بك في خبير قوانين الدرونز! لمساعدتك، يرجى كتابة اسم البلد الذي تود معرفة قوانين الدرونز فيه، أو اختر من الخيارات الشائعة أدناه.", 'bot');
                window.displayQuickActionOptions(['🇸🇦 السعودية', '🇦🇪 الإمارات', '🇪🇬 مصر', '🇯🇴 الأردن'], handleLawsChoice);
            }

            /**
             * Handles the user's country choice for drone laws and triggers the law lookup.
             * @param {string} country - The chosen country name (may include emojis).
             */
            function handleLawsChoice(country) {
                if (!country.trim()) { 
                    appendMessage("الرجاء تحديد اسم البلد الذي تود معرفة قوانينه.", 'bot');
                    return;
                }
                appendMessage({text: country}, 'user');
                quickActionsContainer.innerHTML = ''; 
                chatInput.placeholder = 'لحظات، أقوم بالبحث عن القوانين...';
                chatInput.disabled = true; 
                showTypingIndicator();
                getDroneLaws(country.replace(/[\p{Extended_Pictographic}\s]/gu, ''));
            }

            /**
             * Fetches and displays summarized drone laws for a given country from the LLM.
             * @param {string} country - The cleaned country name.
             */
            async function getDroneLaws(country) {
                const prompt = `أنت خبير في قوانين الطائرات بدون طيار. قم بتلخيص أهم قوانين الدرونز في "${country}" باللغة العربية. ركز على: 1. متطلبات تسجيل الدرون. 2. أهم مناطق الحظر الجوي. 3. القواعد العامة للطيران (الارتفاع، المسافة، التوقيت). 4. قدم إخلاء مسؤولية مهم في النهاية.`;
                const payload = {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json", responseSchema: lawsSchema }
                };
                try {
                    const response = await fetch(getApiUrl(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                    }
                    const result = await response.json();
                    const laws = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || '{}');

                    if (!laws || !laws.registration || !laws.noFlyZones || !laws.generalRules || !laws.disclaimer) {
                        throw new Error("Invalid or incomplete laws data received from the model.");
                    }

                    let htmlContent = `<h4>⚖️ ملخص قوانين الدرونز في ${country}</h4>`;
                    htmlContent += `<div class="info-card"><h4>التسجيل</h4><p>${laws.registration}</p></div>`;
                    htmlContent += `<div class="info-card"><h4>مناطق الحظر الجوي</h4><ul>${laws.noFlyZones.map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                    htmlContent += `<div class="info-card"><h4>قواعد عامة</h4><ul>${laws.generalRules.map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                    htmlContent += `<div class="disclaimer">${laws.disclaimer}</div>`;

                    hideTypingIndicator();
                    appendMessage(null, 'bot', { htmlContent }); 
                } catch (error) {
                    console.error("Error fetching laws:", error);
                    hideTypingIndicator();
                    appendMessage("عذراً، واجهت مشكلة في العثور على القوانين المطلوبة لهذا البلد أو المعلومات غير متوفرة حالياً.", 'bot');
                } finally {
                    resetFlowState(); 
                }
            }

            // 6. General Bot Response Handling (Made global for HTML onclick access)

            /**
             * Formats a structured bot response object (from general chat) into HTML.
             * @param {Object} data - The structured response data containing summary, points, and optional sources.
             * @returns {string} HTML string representation of the response.
             */
            window.formatBotResponse = function(data) { 
                let html = `<p>${data.summary}</p>`;
                if (data.points && data.points.length > 0) {
                    html += `<h4>نقاط رئيسية</h4><ul>${data.points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                }
                if (data.sources && data.sources.length > 0) {
                    html += `<h4>مصادر</h4><ul>${data.sources.map(s => `<li><a href="${s.url}" target="_blank" rel="noopener noreferrer">${s.title}</a></li>`).join('')}</ul>`;
                }
                return html;
            }
            
            /**
             * Sends the current chat history to the LLM to get a general conversational response.
             */
            async function getBotResponse() {
                // Suffix added to user's prompt to keep conversation focused on drones
                const promptSuffix = ` يرجى التركيز في إجابتك على مواضيع الدرونز فقط، مثل استخداماتها، أنواعها، صيانتها، تقنياتها، أخبارها، أو أي شيء ذي صلة بعالم الدرونز. لا تتحدث في مواضيع عامة خارج نطاق الدرونز.`;
                const fullChatHistory = chatHistory.map(msg => ({
                    role: msg.role,
                    parts: [{ text: msg.role === 'user' ? msg.parts[0].text + promptSuffix : msg.parts[0].text }]
                }));

                const finalPayload = { 
                    contents: fullChatHistory, 
                    generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema }
                };
                try {
                    const response = await fetch(getApiUrl(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload) 
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                    }
                    const result = await response.json();
                    let botResponse = { summary: "عذراً، لم أتمكن من العثور على إجابة.", points: [] };
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        try {
                            botResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                            if (!botResponse.summary || !Array.isArray(botResponse.points)) {
                                throw new Error("Parsed bot response missing required fields.");
                            }
                        } catch (parseError) {
                            console.error("Error parsing bot response JSON:", parseError);
                            botResponse.summary = "حدث خطأ في فهم استجابة الذكاء الاصطناعي.";
                            botResponse.points = [];
                            botResponse.sources = [];
                        }
                    }
                    
                    chatHistory.push({ role: 'model', parts: [{ text: JSON.stringify(botResponse) }] });
                    saveChatHistory(); 
                    hideTypingIndicator(); 
                    appendMessage(botResponse, 'bot'); 

                } catch (error) {
                    console.error("Error fetching or processing bot response:", error);
                    hideTypingIndicator();
                    appendMessage("حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.", 'bot');
                }
            }
            
            /**
             * Fetches suggested follow-up questions from the LLM based on a given prompt.
             * @param {string} prompt - The prompt to send to the LLM for generating suggestions.
             * @returns {Promise<string[]>} A promise that resolves to an array of suggested questions.
             */
            async function getSuggestions(prompt) {
                if (isSuggesting) return ["الرجاء الانتظار، جاري جلب الاقتراحات..."]; 
                isSuggesting = true;
                const payload = {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json", responseSchema: questionsSchema }
                };
                try {
                    const response = await fetch(getApiUrl(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                    }
                    const result = await response.json();
                    const parsedResult = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || '{}');
                    return parsedResult.questions || [];
                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                    return ["حدث خطأ أثناء جلب الاقتراحات. يرجى المحاولة يدوياً."]; 
                } finally {
                    isSuggesting = false; 
                }
            }

            /**
             * Fetches and displays initial quick action suggestions for new users or when the Suggestions button is clicked.
             */
            async function getInitialSuggestions() {
                displaySuggestionLoader(quickActionsContainer);
                // Updated prompt to request very simple and concise (around 5-7 words) questions
                const prompt = "أنت مساعد ذكاء اصطناعي متخصص في الدرونز. اقترح 3 أسئلة بسيطة جداً وموجزة (بحد أقصى 7 كلمات) حول الدرونز أو قوانينها، كل سؤال يبدأ بإيموجي مناسب."; 
                const questions = await getSuggestions(prompt);
                window.displaySuggestionButtons(quickActionsContainer, questions);
            }

            /**
             * Fetches and displays follow-up suggestions for a specific bot message.
             * @param {number} messageId - The ID of the message container to attach suggestions to.
             */
            window.getFollowUpSuggestions = async function(messageId) { 
                const container = document.getElementById(`follow-up-container-${messageId}`);
                if (!container) return; 

                displaySuggestionLoader(container); 
                // Updated prompt to request very simple and concise (around 5-7 words) follow-up suggestions
                const prompt = `بناءً على سجل المحادثة التالي الذي يتركز على الدرونز، اقترح 3 أسئلة متابعة بسيطة جداً وموجزة (بحد أقصى 7 كلمات) ذات صلة، كل سؤال يبدأ بإيموجي مناسب.`; 
                const questions = await getSuggestions(prompt);
                window.displaySuggestionButtons(container, questions);
            }
            
            /**
             * Saves the current chat history to session storage for persistence across sessions.
             */
            function saveChatHistory() {
                sessionStorage.setItem('arabDronesChatHistory', JSON.stringify(chatHistory));
            }
            
            /**
             * Loads chat history from session storage on page load.
             * If no history is found, it displays an initial welcome message and suggestions.
             */
            function loadChatHistory() {
                const savedHistory = sessionStorage.getItem('arabDronesChatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    chatMessages.innerHTML = ''; 
                    chatHistory.forEach(item => {
                        const isInitialLoadMessage = chatHistory.indexOf(item) === 0; 
                        if (item.role === 'user') {
                            appendMessage(item.parts[0], 'user');
                        } else if (item.role === 'model') {
                            try {
                                appendMessage(JSON.parse(item.parts[0].text), 'bot', { isInitial: isInitialLoadMessage });
                            } catch (e) {
                                appendMessage(item.parts[0].text, 'bot', { isInitial: isInitialLoadMessage });
                            }
                        }
                    });
                    scrollToBottom();
                } else {
                    const initialMsg = "أهلاً بك في مساعد عرب درونز الذكي. كيف يمكنني مساعدتك اليوم؟";
                    appendMessage(initialMsg, 'bot', { isInitial: true });
                    chatHistory.push({role: 'model', parts: [{text: initialMsg}]});
                    saveChatHistory();
                    getInitialSuggestions(); // Call suggestions on initial load
                }
            }

            // 7. Initializers and Event Listeners (Main entry point for application logic)
            loadTheme(); 
            loadChatHistory(); 

            chatForm.addEventListener('submit', handleFormSubmit); 
            themeToggleBtn.addEventListener('click', toggleTheme); 
            
            // Event listeners for the specific tool buttons
            droneLawsBtn.addEventListener('click', startLawsFlow);
            suggestionsBtn.addEventListener('click', getInitialSuggestions); // Listener for Suggestions button

            // Removed Service Worker registration logic
        }); // --- END OF DOMContentLoaded ---
    </script>

</body>
</html>
